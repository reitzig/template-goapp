name: Trigger Release

on:
  workflow_dispatch:

jobs:
  trigger-release:
    runs-on: 'ubuntu-latest'
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3
      with:
        install: false # we only need env

    # TODO: test again?

    - name: Install changie
      uses: miniscruff/changie-action@6dcc2533cac0495148ed4046c438487e4dceaa23 # v2
      with:
        args: --version

    - name: Assemble release notes
      id: release_notes
      run: |
          changie batch auto
          changie merge
          git status
          echo "version=$(changie latest)" >> "$GITHUB_OUTPUT"

    - name: Commit changelog
      run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"

          git add ".changes/$(changie latest).md"
          git commit --all -m "chore(doc): CHANGELOG for $(changie latest)"
          git push origin

    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
      with:
        version: latest
        args: --clean --release-notes=.changes/${{ steps.release_notes.outputs.version }}.md --verbose --skip=validate
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GORELEASER_CURRENT_TAG: "${{ steps.release_notes.outputs.version }}"
