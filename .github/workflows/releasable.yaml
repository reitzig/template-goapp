name: Confirm Releasability

on:
  pull_request:
    types:
    - opened
    - synchronize
    - reopened

jobs:
  build:
    runs-on: 'ubuntu-latest'
    steps:
    - uses: actions/checkout@v4

    # Kudos: https://github.com/miniscruff/changie/blob/76fdd65ab31047fd6d506f800a6293f3b2a1ead0/.github/workflows/changelog-check.yml
    - name: "Check for changelog entries"
      uses: brettcannon/check-for-changed-files@v1.2.0
      with:
        file-pattern: |
          .changes/unreleased/*.yaml
          CHANGELOG.md
        skip-label: "skip changelog"
        failure-message: |
          Missing a new changelog entry.
          Please add one with `changie new`, or
          apply label '${skip-label}' label to the pull request."

    - name: Test release note assembly
      uses: miniscruff/changie-action@v2
      with:
        args: batch auto

    - name: Test changelog assembly
      uses: miniscruff/changie-action@v2
      with:
        args: merge

    - name: Test computation of next version
      uses: miniscruff/changie-action@v2
      with:
        args: next auto
